# Ansible playbook
- name: Set up the containers
  hosts: stasmo.wtf
  vars:
    app_port: 80
    mongo_db: bittrextoolsdb
    mongo_user: stasmo
    mongo_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38633866386333383035363731343362336662643233323138383735383136313761373131396330
          3036656132356539373238316637663532613266663936640a306265613336316363616634613339
          64643339396531393632313731323837373736356166303636346535393939636166306231653230
          3761636434366632310a613463363236336465323130666636393236393433636637363138333664
          3736
    sendgrid_api_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          62616132623532643462623530613133303735656239656535383463313134363634653035643734
          3162306436626666613331643137383230336562386665370a353733646363643234633937343536
          35663435326334356165346631653231613035356339623031383765316365373739323638393434
          3864353761346434310a333637643539393138323638316662313930616439383939613335343734
          36373866663634616162356434336330633233336262393733343035373631663038336432343761
          63666464643531623662313233646162343331383861636231623136653131396430323463616564
          37656166383163333764653239653436303661396162363263396438653231666366366332303738
          61333932303031353831
    certbot_install_from_source: yes
  roles:
    - role: geerlingguy.certbot
      become: yes
  tasks:
    - docker_container:
        name: server
        state: absent
    - shell: letsencrypt certonly --agree-tos --email simon@staszkiewicz.ca --noninteractive --standalone -d stasmo.wtf
      become: yes
    - docker_container:
        restart_policy: always
        image: mongo
        name: bittrex_mongo
        volumes:
          - "{{ ansible_user_dir}}/mongodata:/data/db"
    - docker_container:
        pull: yes
        restart_policy: always
        image: stasmo/bittrex-tools
        name: server
        volumes:
          - /etc/letsencrypt:/certs
        ports:
          - "80:80"
          - "443:443"
        links:
          - bittrex_mongo:mongo
        env:
          DATABASE_STRING: 'mongodb://mongo/bittrex_tools'
          PORT: "{{ app_port }}"
          SSL: 'true'
          CERTS_DIR: /certs/live/stasmo.wtf/
          SENDGRID_API_KEY: "{{ sendgrid_api_key }}"
        command: npm start